<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Tracker">
    <meta name="description" content="Real-time vehicle tracking and monitoring">
    <title>Vehicle Tracker</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.png">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Tailwind CSS for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- jsQR for QR Code Scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsqr.min.js"></script>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="bg-gray-100 font-sans">
    
    <!-- Top Navigation Bar -->
    <nav class="bg-blue-600 text-white shadow-lg sticky top-0 z-50">
        <div class="flex items-center gap-3 px-4 py-3">
            <!-- BLE Icon - Now Clickable -->
            <button id="bleListBtn" class="p-1 hover:bg-blue-700 rounded-lg transition flex-shrink-0">
                <i data-lucide="bluetooth" class="w-6 h-6"></i>
            </button>
            
            <!-- Search Bar -->
            <div class="flex-1 relative">
                <input 
                    type="text" 
                    id="searchInput" 
                    placeholder="Search vehicles" 
                    class="w-full px-4 py-2 rounded-lg bg-white/90 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-white/50 focus:bg-white transition"
                />
                <!-- Search Results Dropdown -->
                <div id="searchResults" class="hidden absolute top-full left-0 right-0 mt-2 bg-white rounded-lg shadow-2xl max-h-96 overflow-y-auto z-50">
                    <div id="searchResultsList" class="py-2">
                        <!-- Results will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- BLE Tags List Panel (Top-Left Sidebar) -->
    <div id="bleTagsPanel" class="fixed top-[60px] left-0 w-80 h-[calc(100vh-124px)] bg-white shadow-2xl transform -translate-x-full transition-transform duration-300 z-50 overflow-hidden">
        <div class="flex flex-col h-full">
            <!-- Header -->
            <div class="p-4 border-b border-gray-200 bg-blue-600 text-white">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-bold">BLE Tags</h2>
                    <button id="closeBleListBtn" class="p-2 hover:bg-blue-700 rounded-lg transition">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            
            <!-- Loading Indicator -->
            <div id="vehiclesLoading" class="hidden p-4 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                <p class="text-sm text-gray-500 mt-2">Loading vehicles...</p>
            </div>
            
            <!-- Tags List (Scrollable) -->
            <div id="bleTagsList" class="flex-1 overflow-y-auto">
                <!-- Vehicles will be populated here -->
                <div class="text-center text-gray-500 py-8">
                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2 text-gray-400"></i>
                    <p>No vehicles found</p>
                    <p class="text-sm mt-1">Click to load vehicles</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container (Full Screen) -->
    <div id="map" class="w-full h-screen"></div>

    <!-- Reports Panel (Hidden by default, shown when Reports tab clicked) -->
    <div id="reportsPanel" class="hidden fixed inset-0 bg-gray-50 z-30 overflow-y-auto pb-20 pt-16">
        <div class="max-w-4xl mx-auto p-4">
            <!-- Header -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-4">
                <div class="flex justify-between items-start">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800 mb-2">
                            <i data-lucide="file-text" class="inline w-7 h-7 mr-2 text-blue-600"></i>
                            Journey Reports
                        </h1>
                        <p class="text-sm text-gray-600">View journey history for your vehicles</p>
                    </div>
                    <button id="clearRouteBtn" class="hidden px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg flex items-center gap-2 transition">
                        <i data-lucide="x" class="w-4 h-4"></i>
                        Clear Route
                    </button>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-4">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Filters</h2>
                
                <!-- BLE Tag Selector -->
                <div class="mb-4">
                    <label for="reportVehicleSelect" class="block text-sm font-medium text-gray-700 mb-2">
                        <i data-lucide="car" class="inline w-4 h-4"></i> Select Tag
                    </label>
                    <select id="reportVehicleSelect" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-white">
                        <option value="">-- Select a Tag --</option>
                    </select>
                </div>

                <!-- Period Selector -->
                <div class="mb-4">
                    <label for="reportPeriodSelect" class="block text-sm font-medium text-gray-700 mb-2">
                        <i data-lucide="calendar" class="inline w-4 h-4"></i> Period
                    </label>
                    <select id="reportPeriodSelect" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 bg-white">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="thisWeek">This Week</option>
                        <option value="prevWeek">Previous Week</option>
                        <option value="thisMonth">This Month</option>
                        <option value="prevMonth">Previous Month</option>
                        <option value="custom">Custom Date Range</option>
                    </select>
                </div>

                <!-- Custom Date Range (Hidden by default) -->
                <div id="customDateRange" class="hidden mb-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="startDate" class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                            <input type="date" id="startDate" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                        </div>
                        <div>
                            <label for="endDate" class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                            <input type="date" id="endDate" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                        </div>
                    </div>
                </div>

                <!-- Show Button -->
                <button id="showTripsBtn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i data-lucide="search" class="w-5 h-5"></i>
                    Show Journeys
                </button>
            </div>

            <!-- Loading Indicator -->
            <div id="tripsLoading" class="hidden bg-white rounded-lg shadow-md p-8 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Loading journeys...</p>
            </div>

            <!-- Trips List -->
            <div id="tripsList" class="space-y-3">
                <!-- Empty state -->
                <div id="tripsEmptyState" class="bg-white rounded-lg shadow-md p-12 text-center">
                    <i data-lucide="inbox" class="w-16 h-16 mx-auto mb-4 text-gray-300"></i>
                    <p class="text-gray-500 font-medium mb-2">No journeys to display</p>
                    <p class="text-sm text-gray-400">Select a vehicle and period, then click "Show Journeys"</p>
                </div>
            </div>

            <!-- Trips Count Summary -->
            <div id="tripsSummary" class="hidden bg-white rounded-lg shadow-md p-4 mt-4">
                <div class="flex items-center justify-between text-sm">
                    <span class="text-gray-600">
                        <span id="tripsCount" class="font-bold text-blue-600">0</span> trips found
                    </span>
                    <span class="text-gray-600">
                        Total Distance: <span id="totalDistance" class="font-bold text-green-600">0 km</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Action Button -->
    <button id="addTagBtn" class="fixed bottom-20 right-4 bg-blue-600 text-white p-4 rounded-full shadow-2xl hover:bg-blue-700 transition-all active:scale-95 z-40">
        <i data-lucide="plus" class="w-7 h-7"></i>
    </button>

    <!-- Bottom Sheet Menu -->
    <div id="bottomSheet" class="fixed inset-x-0 bottom-0 bg-white rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 z-50 max-h-[80vh] overflow-y-auto">
        <div class="p-6">
            <!-- Handle Bar -->
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-6"></div>
            
            <h2 class="text-xl font-bold text-gray-800 mb-6">Add Vehicle</h2>
            
            <!-- Vehicle ID Input -->
            <div class="mb-6">
                <label for="imeiInput" class="block text-sm font-medium text-gray-700 mb-2">
                    <i data-lucide="hash" class="w-4 h-4 inline"></i> Enter Vehicle ID
                </label>
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="imeiInput" 
                        placeholder="72753c0d-4202-4836-bf9a-aaa30fedefc4" 
                        class="flex-1 border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-mono text-sm"
                        maxlength="36">
                    <button id="addManualBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 transition">
                        Add
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">Enter a Vehicle ID (GUID) or 15-digit IMEI</p>
            </div>

            <!-- Divider -->
            <div class="flex items-center my-6">
                <div class="flex-1 border-t border-gray-300"></div>
                <span class="px-4 text-sm text-gray-500">OR</span>
                <div class="flex-1 border-t border-gray-300"></div>
            </div>

            <!-- QR Scanner Button -->
            <button id="scanQRBtn" class="w-full bg-gray-100 text-gray-800 py-4 rounded-lg font-medium hover:bg-gray-200 transition flex items-center justify-center gap-2">
                <i data-lucide="scan" class="w-5 h-5"></i>
                Scan QR Code
            </button>

            <!-- Close Button -->
            <button id="closeSheetBtn" class="w-full mt-4 text-gray-500 py-3 rounded-lg hover:bg-gray-100 transition">
                Cancel
            </button>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="qrModal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-[60] flex items-center justify-center">
        <div class="relative w-full max-w-lg mx-4">
            <button id="closeQRBtn" class="absolute top-4 right-4 bg-white text-gray-800 p-2 rounded-full shadow-lg z-10 hover:bg-gray-100">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            
            <div class="bg-white rounded-2xl overflow-hidden shadow-2xl">
                <div class="bg-blue-600 text-white px-6 py-4">
                    <h3 class="text-lg font-bold">Scan QR Code</h3>
                    <p class="text-sm text-blue-100">Position the QR code within the frame</p>
                </div>
                
                <div class="relative bg-black">
                    <video id="qrVideo" class="w-full h-auto" playsinline></video>
                    <canvas id="qrCanvas" class="hidden"></canvas>
                    
                    <!-- Scanning Overlay -->
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div class="w-64 h-64 border-4 border-blue-500 rounded-2xl opacity-50"></div>
                    </div>
                </div>
                
                <div class="p-4 bg-gray-50">
                    <p id="qrStatus" class="text-sm text-gray-600 text-center">Initializing camera...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Tag Info Panel (Slide from bottom when tag clicked) -->
    <div id="tagInfoPanel" class="fixed inset-x-0 bottom-0 bg-white rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 z-40 max-h-[60vh] overflow-y-auto">
        <div class="p-6">
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-4"></div>
            
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1">
                    <!-- Editable Description -->
                    <div id="tagTitleDisplay" class="flex items-center gap-2">
                        <h3 class="text-lg font-bold text-gray-800" id="tagTitle">BLE Tag</h3>
                        <button id="editDescBtn" class="p-1 hover:bg-gray-100 rounded transition">
                            <i data-lucide="edit-2" class="w-4 h-4 text-gray-500"></i>
                        </button>
                    </div>
                    <div id="tagTitleEdit" class="hidden flex items-center gap-2 mb-2">
                        <input type="text" id="tagDescInput" class="flex-1 border-2 border-blue-500 rounded-lg px-3 py-2 text-sm font-bold" maxlength="30" placeholder="Enter tag name">
                        <button id="saveDescBtn" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            <i data-lucide="check" class="w-4 h-4"></i>
                        </button>
                        <button id="cancelDescBtn" class="p-2 bg-gray-200 text-gray-600 rounded-lg hover:bg-gray-300 transition">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 hidden" id="tagIMEI">IMEI: --</p>
                </div>
                <button id="closeTagInfoBtn" class="p-2 hover:bg-gray-100 rounded-lg transition">
                    <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                </button>
            </div>

            <div class="space-y-3 mb-4">
                <div class="flex items-center gap-3 text-sm">
                    <i data-lucide="map-pin" class="w-5 h-5 text-blue-600"></i>
                    <div>
                        <p class="font-medium text-gray-700">Location</p>
                        <p class="text-gray-600" id="tagLocation">--</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 text-sm">
                    <i data-lucide="clock" class="w-5 h-5 text-blue-600"></i>
                    <div>
                        <p class="font-medium text-gray-700">Last Updated</p>
                        <p class="text-gray-600" id="tagLastUpdate">--</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 text-sm hidden">
                    <i data-lucide="activity" class="w-5 h-5 text-blue-600"></i>
                    <div>
                        <p class="font-medium text-gray-700">Status</p>
                        <p class="text-gray-600" id="tagStatus">--</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 text-sm">
                    <i data-lucide="info" class="w-5 h-5 text-blue-600"></i>
                    <div>
                        <p class="font-medium text-gray-700">Event Type</p>
                        <p class="text-gray-600" id="tagEventType">--</p>
                    </div>
                </div>
            </div>

            <button id="centerMapBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition flex items-center justify-center gap-2">
                <i data-lucide="focus" class="w-5 h-5"></i>
                Center on Map
            </button>
            
            <!-- Delete Tag Button -->
            <button id="removeTagBtn" class="w-full mt-2 bg-red-50 text-red-600 py-3 rounded-lg font-medium hover:bg-red-100 transition flex items-center justify-center gap-2">
                <i data-lucide="trash-2" class="w-5 h-5"></i>
                Remove Tag
            </button>
        </div>
    </div>

    <!-- Modern Menu Panel (Slide from bottom when menu clicked) -->
    <div id="savedTagsPanel" class="fixed inset-x-0 bottom-0 bg-white rounded-t-3xl shadow-2xl transform translate-y-full transition-transform duration-300 z-40 max-h-[80vh] overflow-y-auto">
        <div class="p-6">
            <!-- Drag Handle -->
            <div class="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mb-4"></div>
            
            <!-- Header with Close Button -->
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">Menu</h3>
                <button id="closeSavedTagsBtn" class="p-2 hover:bg-gray-100 rounded-lg transition">
                    <i data-lucide="x" class="w-5 h-5 text-gray-600"></i>
                </button>
            </div>
            
            <!-- Tab Navigation -->
            <div class="flex border-b border-gray-200 mb-4">
                <button id="myTagsTab" class="flex-1 py-3 px-4 font-medium text-blue-600 border-b-2 border-blue-600 transition">
                    <i data-lucide="list" class="w-4 h-4 inline mr-2"></i>My Tags
                </button>
                <button id="adminTab" class="flex-1 py-3 px-4 font-medium text-gray-500 border-b-2 border-transparent transition hover:text-gray-700">
                    <i data-lucide="settings" class="w-4 h-4 inline mr-2"></i>Admin
                </button>
            </div>
            
            <!-- My Tags Content -->
            <div id="myTagsContent" class="tab-content">
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <p class="text-sm text-gray-500">
                            <span id="tagCount">0</span> vehicles tracked
                        </p>
                        <button id="refreshAllBtn" class="text-sm text-blue-600 hover:text-blue-700 font-medium flex items-center gap-1">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i>Refresh All
                        </button>
                    </div>
                    
                    <div id="savedTagsList" class="space-y-2">
                        <!-- Tags will be dynamically inserted here -->
                        <div class="text-center py-12" id="noTagsMessage">
                            <i data-lucide="map-pin-off" class="w-16 h-16 text-gray-300 mx-auto mb-3"></i>
                            <p class="text-gray-400 font-medium">No vehicles tracked yet</p>
                            <p class="text-sm text-gray-400 mt-1">Add a vehicle from the Admin tab</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin Content -->
            <div id="adminContent" class="tab-content hidden">
                <!-- Add Vehicle Section -->
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <i data-lucide="plus-circle" class="w-4 h-4"></i>Add Vehicle
                    </h4>
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="adminImeiInput" 
                                placeholder="Enter Vehicle ID or IMEI" 
                                class="flex-1 border-2 border-gray-300 rounded-lg px-4 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 font-mono text-sm"
                                maxlength="36">
                            <button id="adminAddBtn" class="bg-blue-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-blue-700 transition flex items-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i>Add
                            </button>
                        </div>
                        <button id="adminScanBtn" class="w-full bg-gray-100 text-gray-700 py-3 rounded-lg font-medium hover:bg-gray-200 transition flex items-center justify-center gap-2">
                            <i data-lucide="qr-code" class="w-5 h-5"></i>
                            Scan QR Code
                        </button>
                    </div>
                </div>
                
                <!-- Manage Vehicles Section -->
                <div class="mb-6">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2">
                        <i data-lucide="edit" class="w-4 h-4"></i>Manage Vehicles
                    </h4>
                    <div class="space-y-2">
                        <!-- Selected vehicle display -->
                        <div id="adminSelectedVehicle" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                            <p class="text-xs text-gray-500 mb-1">Selected Vehicle:</p>
                            <p class="font-medium text-gray-800" id="adminSelectedName">--</p>
                            <p class="text-xs text-gray-500 font-mono" id="adminSelectedId">--</p>
                        </div>
                        
                        <!-- Rename Section -->
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="adminRenameInput" 
                                placeholder="New name for selected vehicle" 
                                class="flex-1 border-2 border-gray-300 rounded-lg px-4 py-2.5 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 text-sm"
                                maxlength="30"
                                disabled>
                            <button id="adminRenameBtn" class="bg-green-600 text-white px-5 py-2.5 rounded-lg font-medium hover:bg-green-700 transition flex items-center gap-2 disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                                <i data-lucide="pencil" class="w-4 h-4"></i>Rename
                            </button>
                        </div>
                        
                        <!-- Delete Button -->
                        <button id="adminDeleteBtn" class="w-full bg-red-50 text-red-600 py-3 rounded-lg font-medium hover:bg-red-100 transition flex items-center justify-center gap-2 disabled:bg-gray-100 disabled:text-gray-400 disabled:cursor-not-allowed" disabled>
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                            Delete Selected Vehicle
                        </button>
                        
                        <!-- Clear All Button -->
                        <button id="clearAllTagsBtn" class="w-full bg-gray-100 text-gray-600 py-2.5 rounded-lg font-medium hover:bg-gray-200 transition flex items-center justify-center gap-2">
                            <i data-lucide="x-circle" class="w-4 h-4"></i>
                            Clear All Vehicles
                        </button>
                    </div>
                </div>
                
                <!-- Auto-refresh Info -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="flex items-start gap-2">
                        <i data-lucide="info" class="w-4 h-4 text-blue-600 mt-0.5"></i>
                        <div class="text-xs text-blue-800">
                            <p class="font-medium mb-1">Auto-Refresh Enabled</p>
                            <p>Locations update every 10 minutes automatically</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 shadow-2xl">
            <div class="flex flex-col items-center gap-4">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
                <p class="text-gray-700 font-medium">Loading location...</p>
            </div>
        </div>
    </div>

    <!-- Settings Blade (Sidebar) -->
    <div id="settingsBlade" class="fixed inset-0 z-[60] hidden">
        <!-- Overlay -->
        <div id="settingsOverlay" class="absolute inset-0 bg-black bg-opacity-50 transition-opacity"></div>
        
        <!-- Blade Panel -->
        <div id="settingsPanel" class="absolute top-0 left-0 h-full w-80 bg-white shadow-2xl transform -translate-x-full transition-transform duration-300">
            <!-- Header -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 pb-8">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-2xl font-bold">Settings</h2>
                    <button id="closeSettingsBtn" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <p class="text-blue-100 text-sm">Manage your preferences</p>
            </div>
            
            <!-- Menu Items -->
            <div class="py-4">
                <!-- Account -->
                <button id="settingsAccount" class="w-full px-6 py-4 flex items-center gap-4 hover:bg-gray-50 transition group">
                    <div class="bg-blue-100 p-3 rounded-lg group-hover:bg-blue-200 transition">
                        <i data-lucide="user" class="w-5 h-5 text-blue-600"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <h3 class="font-semibold text-gray-800">Account</h3>
                        <p class="text-sm text-gray-500">Profile and preferences</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                </button>
                
                <!-- Devices -->
                <button id="settingsDevices" class="w-full px-6 py-4 flex items-center gap-4 hover:bg-gray-50 transition group">
                    <div class="bg-green-100 p-3 rounded-lg group-hover:bg-green-200 transition">
                        <i data-lucide="smartphone" class="w-5 h-5 text-green-600"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <h3 class="font-semibold text-gray-800">Devices</h3>
                        <p class="text-sm text-gray-500">Manage connected devices</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                </button>
                
                <!-- Alerts -->
                <button id="settingsAlerts" class="w-full px-6 py-4 flex items-center gap-4 hover:bg-gray-50 transition group">
                    <div class="bg-orange-100 p-3 rounded-lg group-hover:bg-orange-200 transition">
                        <i data-lucide="bell" class="w-5 h-5 text-orange-600"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <h3 class="font-semibold text-gray-800">Alerts</h3>
                        <p class="text-sm text-gray-500">Notification settings</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                </button>
                
                <!-- Divider -->
                <div class="border-t border-gray-200 my-4"></div>
                
                <!-- About -->
                <button id="settingsAbout" class="w-full px-6 py-4 flex items-center gap-4 hover:bg-gray-50 transition group">
                    <div class="bg-gray-100 p-3 rounded-lg group-hover:bg-gray-200 transition">
                        <i data-lucide="info" class="w-5 h-5 text-gray-600"></i>
                    </div>
                    <div class="flex-1 text-left">
                        <h3 class="font-semibold text-gray-800">About</h3>
                        <p class="text-sm text-gray-500">App version and info</p>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-400"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Account Settings Panel -->
    <div id="accountPanel" class="fixed inset-0 z-[70] hidden bg-white">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 pb-8">
            <div class="flex items-center gap-4 mb-2">
                <button id="backFromAccount" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h2 class="text-2xl font-bold">Account Settings</h2>
            </div>
            <p class="text-blue-100 text-sm ml-14">Manage your profile and preferences</p>
        </div>
        
        <!-- Content -->
        <div class="overflow-y-auto pb-20" style="height: calc(100% - 120px);">
            <div class="max-w-2xl mx-auto p-6">
                <!-- Profile Section -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-lucide="user" class="w-5 h-5 text-blue-600"></i>
                        Profile Information
                    </h3>
                    
                    <!-- Name -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                        <input type="text" id="accountName" placeholder="Enter your name" 
                               class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    </div>
                    
                    <!-- Email -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="accountEmail" placeholder="Enter your email" 
                               class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    </div>
                    
                    <!-- Password -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="accountPassword" placeholder="Enter new password" 
                               class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                        <p class="text-xs text-gray-500 mt-1">Leave blank to keep current password</p>
                    </div>
                    
                    <!-- Save Button -->
                    <button id="saveAccountBtn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-medium hover:bg-blue-700 transition flex items-center justify-center gap-2">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        Save Changes
                    </button>
                </div>
                
                <!-- Preferences Section -->
                <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5 text-blue-600"></i>
                        Preferences
                    </h3>
                    
                    <!-- Default Map Provider -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Default Map Provider</label>
                        <select id="mapProviderSelect" class="w-full border-2 border-gray-300 rounded-lg px-4 py-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                            <option value="google">Google Maps</option>
                            <option value="osm">OpenStreetMap</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Choose your preferred map tiles</p>
                    </div>
                    
                    <!-- Save Preferences Button -->
                    <button id="savePreferencesBtn" class="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 transition flex items-center justify-center gap-2">
                        <i data-lucide="check" class="w-5 h-5"></i>
                        Save Preferences
                    </button>
                </div>
                
                <!-- Danger Zone -->
                <div class="bg-white rounded-lg shadow-md p-6 border-2 border-red-200">
                    <h3 class="text-lg font-semibold text-red-600 mb-2 flex items-center gap-2">
                        <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                        Danger Zone
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">Once you delete your account, there is no going back. Please be certain.</p>
                    <button id="deleteAccountBtn" class="w-full bg-red-600 text-white py-3 rounded-lg font-medium hover:bg-red-700 transition flex items-center justify-center gap-2">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                        Delete Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Devices Panel -->
    <div id="devicesPanel" class="fixed inset-0 z-[70] hidden bg-white">
        <!-- Header -->
        <div class="bg-gradient-to-r from-green-600 to-green-700 text-white p-6 pb-8">
            <div class="flex items-center gap-4 mb-2">
                <button id="backFromDevices" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h2 class="text-2xl font-bold">BLE Devices</h2>
            </div>
            <p class="text-green-100 text-sm ml-14">Manage your tracked devices</p>
        </div>
        
        <!-- Content -->
        <div class="overflow-y-auto pb-20" style="height: calc(100% - 120px);">
            <div class="max-w-2xl mx-auto p-6">
                <!-- Export Button -->
                <div class="mb-6">
                    <button id="exportDevicesBtn" class="w-full bg-green-600 text-white py-3 rounded-lg font-medium hover:bg-green-700 transition flex items-center justify-center gap-2">
                        <i data-lucide="download" class="w-5 h-5"></i>
                        Export to Excel
                    </button>
                </div>
                
                <!-- Devices List -->
                <div id="devicesList" class="space-y-4">
                    <!-- Devices will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts Panel -->
    <div id="alertsPanel" class="fixed inset-0 z-[70] hidden bg-white">
        <!-- Header -->
        <div class="bg-gradient-to-r from-orange-600 to-orange-700 text-white p-6 pb-8">
            <div class="flex items-center gap-4 mb-2">
                <button id="backFromAlerts" class="p-2 hover:bg-white hover:bg-opacity-20 rounded-lg transition">
                    <i data-lucide="arrow-left" class="w-6 h-6"></i>
                </button>
                <h2 class="text-2xl font-bold">Alerts</h2>
            </div>
            <p class="text-orange-100 text-sm ml-14">Notification settings</p>
        </div>
        
        <!-- Content -->
        <div class="flex items-center justify-center" style="height: calc(100% - 120px);">
            <div class="text-center p-8">
                <div class="bg-orange-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i data-lucide="bell" class="w-12 h-12 text-orange-600"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-800 mb-2">Coming Soon</h3>
                <p class="text-gray-600 mb-6">Alert management features will be available in a future update.</p>
                <div class="inline-flex gap-2 text-sm text-gray-500">
                    <i data-lucide="clock" class="w-4 h-4"></i>
                    <span>Stay tuned!</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Popup Menu -->
    <div id="accountPopup" class="fixed bottom-20 right-4 z-[60] hidden">
        <div class="bg-white rounded-lg shadow-2xl border-2 border-gray-200 overflow-hidden min-w-[200px]">
            <!-- Account Option -->
            <button id="accountPopupAccount" class="w-full px-6 py-4 flex items-center gap-3 hover:bg-blue-50 transition text-left">
                <div class="bg-blue-100 p-2 rounded-lg">
                    <i data-lucide="user" class="w-5 h-5 text-blue-600"></i>
                </div>
                <div>
                    <h4 class="font-semibold text-gray-800">Account</h4>
                    <p class="text-xs text-gray-500">Profile settings</p>
                </div>
            </button>
            
            <!-- Divider -->
            <div class="border-t border-gray-200"></div>
            
            <!-- Logout Option -->
            <button id="accountPopupLogout" class="w-full px-6 py-4 flex items-center gap-3 hover:bg-red-50 transition text-left">
                <div class="bg-red-100 p-2 rounded-lg">
                    <i data-lucide="log-out" class="w-5 h-5 text-red-600"></i>
                </div>
                <div>
                    <h4 class="font-semibold text-red-600">Logout</h4>
                    <p class="text-xs text-gray-500">Sign out of app</p>
                </div>
            </button>
        </div>
    </div>

    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Bottom Navigation Bar -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50 safe-area-bottom">
        <div class="flex items-center justify-around h-16">
            <!-- Map Tab -->
            <button id="navMap" class="nav-item flex flex-col items-center justify-center flex-1 h-full transition-colors active">
                <i data-lucide="map" class="w-6 h-6 mb-1"></i>
                <span class="text-xs font-medium">MAP</span>
            </button>
            
            <!-- Reports Tab -->
            <button id="navReports" class="nav-item flex flex-col items-center justify-center flex-1 h-full transition-colors">
                <i data-lucide="file-text" class="w-6 h-6 mb-1"></i>
                <span class="text-xs font-medium">REPORTS</span>
            </button>
            
            <!-- Settings Tab -->
            <button id="navSettings" class="nav-item flex flex-col items-center justify-center flex-1 h-full transition-colors">
                <i data-lucide="settings" class="w-6 h-6 mb-1"></i>
                <span class="text-xs font-medium">SETTINGS</span>
            </button>
            
            <!-- Account Tab -->
            <button id="navAccount" class="nav-item flex flex-col items-center justify-center flex-1 h-full transition-colors">
                <i data-lucide="user" class="w-6 h-6 mb-1"></i>
                <span class="text-xs font-medium">ACCOUNT</span>
            </button>
        </div>
    </nav>
    
    <!-- Custom Scripts -->
    <script src="js/scanner.js"></script>
    <script src="js/map.js"></script>
    
    <!-- Initialize Lucide Icons -->
    <script>
        lucide.createIcons();
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('âœ… Service Worker registered:', registration.scope);
                        
                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute
                    })
                    .catch(error => {
                        console.log('âŒ Service Worker registration failed:', error);
                    });
            });
            
            // Listen for app updates
            let refreshing;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (refreshing) return;
                refreshing = true;
                window.location.reload();
            });
        }
        
        // Handle install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Show install button or banner here if desired
            console.log('ðŸ’¡ PWA install available');
        });
        
        // Optional: Add install button functionality
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('âœ… User accepted PWA install');
                    }
                    deferredPrompt = null;
                });
            }
        }
    </script>
</body>
</html>
